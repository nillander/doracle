#!/bin/bash

# Script para criar o usu√°rio laraveldb e tabela de teste para Laravel
# Execute com: ./create-laravel-user.sh

set -e

# Cores para output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Tentar ler a senha do .env, sen√£o usar padr√£o
if [ -f .env ]; then
    ORACLE_PWD=$(grep "^ORACLE_PWD=" .env | cut -d'=' -f2 | tr -d '"' | tr -d "'" || echo "Oracle123Secure")
else
    ORACLE_PWD="Oracle123Secure"
fi

LARAVEL_PWD="Oracle123Secure"

echo -e "${BLUE}=========================================="
echo "Criar usu√°rio laraveldb para Laravel"
echo "==========================================${NC}"
echo ""

# Verificar se o container est√° rodando
if ! docker compose ps | grep -q "oracle19c.*Up"; then
    echo -e "${RED}‚úó Container oracle19c n√£o est√° rodando${NC}"
    echo "   Execute: docker compose up -d"
    exit 1
fi

# Verificar se o Oracle est√° pronto
CONTAINER_ID=$(docker compose ps -q oracle19c)
HEALTH=$(docker inspect "$CONTAINER_ID" --format='{{.State.Health.Status}}' 2>/dev/null || echo "none")

if [ "$HEALTH" != "healthy" ]; then
    echo -e "${YELLOW}‚ö† Oracle ainda n√£o est√° pronto (Status: $HEALTH)${NC}"
    echo "   Aguarde alguns minutos e execute novamente"
    echo "   Monitore com: docker compose logs -f oracle19c"
    exit 1
fi

echo -e "${GREEN}‚úì Oracle est√° pronto${NC}"
echo ""

# 1. Criar o usu√°rio/schema dentro da PDB ORCLPDB1
echo "1. Criando usu√°rio laraveldb..."
if docker compose exec -T oracle19c sqlplus -s sys/"${ORACLE_PWD}"@localhost:1521/ORCLPDB1 as sysdba <<'SQL' > /dev/null 2>&1
SET PAGESIZE 0 FEEDBACK OFF VERIFY OFF HEADING OFF ECHO OFF
WHENEVER SQLERROR EXIT SQL.SQLCODE
CREATE USER laraveldb IDENTIFIED BY "Oracle123Secure" DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP;
GRANT CONNECT, RESOURCE TO laraveldb;
ALTER USER laraveldb QUOTA UNLIMITED ON USERS;
EXIT;
SQL
then
    echo -e "${GREEN}‚úì Usu√°rio laraveldb criado com sucesso${NC}"
else
    # Verificar se o usu√°rio j√° existe
    USER_EXISTS=$(docker compose exec -T oracle19c sqlplus -s sys/"${ORACLE_PWD}"@localhost:1521/ORCLPDB1 as sysdba <<'SQL' 2>/dev/null | grep -i "laraveldb" || echo "")
SET PAGESIZE 0 FEEDBACK OFF VERIFY OFF HEADING OFF ECHO OFF
SELECT username FROM dba_users WHERE username = 'LARAVELDB';
EXIT;
SQL
)
    if echo "$USER_EXISTS" | grep -qi "laraveldb"; then
        echo -e "${YELLOW}‚ö† Usu√°rio laraveldb j√° existe${NC}"
    else
        echo -e "${RED}‚úó Erro ao criar usu√°rio laraveldb${NC}"
        exit 1
    fi
fi

# 2. Conectar como laraveldb e criar a tabela de teste
echo "2. Criando tabela usuarios..."
if docker compose exec -T oracle19c sqlplus -s laraveldb/"${LARAVEL_PWD}"@localhost:1521/ORCLPDB1 <<'SQL' > /dev/null 2>&1
SET PAGESIZE 0 FEEDBACK OFF VERIFY OFF HEADING OFF ECHO OFF
WHENEVER SQLERROR EXIT SQL.SQLCODE
CREATE TABLE usuarios (
    id   NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    nome VARCHAR2(255) NOT NULL,
    CONSTRAINT usuarios_pk PRIMARY KEY (id)
);
EXIT;
SQL
then
    echo -e "${GREEN}‚úì Tabela usuarios criada com sucesso${NC}"
else
    # Verificar se a tabela j√° existe
    TABLE_EXISTS=$(docker compose exec -T oracle19c sqlplus -s laraveldb/"${LARAVEL_PWD}"@localhost:1521/ORCLPDB1 <<'SQL' 2>/dev/null | grep -i "usuarios" || echo "")
SET PAGESIZE 0 FEEDBACK OFF VERIFY OFF HEADING OFF ECHO OFF
SELECT table_name FROM user_tables WHERE table_name = 'USUARIOS';
EXIT;
SQL
)
    if echo "$TABLE_EXISTS" | grep -qi "usuarios"; then
        echo -e "${YELLOW}‚ö† Tabela usuarios j√° existe${NC}"
    else
        echo -e "${RED}‚úó Erro ao criar tabela usuarios${NC}"
        exit 1
    fi
fi

# 3. Valida√ß√£o completa do usu√°rio laraveldb
echo "3. Validando usu√°rio laraveldb e objetos criados..."
echo ""

# 3.1. Testar conex√£o SQL*Plus
echo "   3.1. Testando conex√£o SQL*Plus..."
SQL_TEST=$(docker compose exec -T oracle19c sqlplus -s laraveldb/"${LARAVEL_PWD}"@localhost:1521/ORCLPDB1 <<'SQL' 2>&1
SET PAGESIZE 0 FEEDBACK OFF VERIFY OFF HEADING OFF ECHO OFF
SELECT 'CONNECTION_OK' FROM DUAL;
EXIT;
SQL
)
if echo "$SQL_TEST" | grep -q "CONNECTION_OK\|Connected"; then
    echo -e "   ${GREEN}‚úì Conex√£o com laraveldb bem-sucedida${NC}"
else
    echo -e "   ${RED}‚úó Erro ao conectar com laraveldb${NC}"
    echo "$SQL_TEST"
    exit 1
fi

# 3.2. Verificar se a tabela usuarios existe
echo "   3.2. Verificando tabela usuarios..."
TABLE_COUNT=$(docker compose exec -T oracle19c sqlplus -s laraveldb/"${LARAVEL_PWD}"@localhost:1521/ORCLPDB1 <<'SQL' 2>/dev/null | tr -d ' ' | grep -E "^[0-9]+$" | head -1 || echo "0")
SET PAGESIZE 0 FEEDBACK OFF VERIFY OFF HEADING OFF ECHO OFF
SELECT COUNT(*) FROM user_tables WHERE table_name = 'USUARIOS';
EXIT;
SQL
)
if [ "$TABLE_COUNT" = "1" ]; then
    echo -e "   ${GREEN}‚úì Tabela usuarios encontrada${NC}"
else
    echo -e "   ${RED}‚úó Tabela usuarios n√£o encontrada (count: $TABLE_COUNT)${NC}"
    exit 1
fi

# 3.3. Verificar estrutura da tabela
echo "   3.3. Verificando estrutura da tabela usuarios..."
TABLE_STRUCTURE=$(docker compose exec -T oracle19c sqlplus -s laraveldb/"${LARAVEL_PWD}"@localhost:1521/ORCLPDB1 <<'SQL' 2>/dev/null
SET PAGESIZE 0 FEEDBACK OFF VERIFY OFF HEADING OFF ECHO OFF
SELECT column_name || ':' || data_type || '(' || data_length || ')'
FROM user_tab_columns
WHERE table_name = 'USUARIOS'
ORDER BY column_id;
EXIT;
SQL
)
if echo "$TABLE_STRUCTURE" | grep -qi "id.*NUMBER\|nome.*VARCHAR2"; then
    echo -e "   ${GREEN}‚úì Estrutura da tabela correta${NC}"
    echo "$TABLE_STRUCTURE" | sed 's/^/      /'
else
    echo -e "   ${YELLOW}‚ö† Estrutura da tabela pode estar incorreta${NC}"
fi

# 3.4. Verificar constraint de primary key
echo "   3.4. Verificando constraint de primary key..."
PK_EXISTS=$(docker compose exec -T oracle19c sqlplus -s laraveldb/"${LARAVEL_PWD}"@localhost:1521/ORCLPDB1 <<'SQL' 2>/dev/null | grep -i "usuarios_pk" || echo "")
SET PAGESIZE 0 FEEDBACK OFF VERIFY OFF HEADING OFF ECHO OFF
SELECT constraint_name FROM user_constraints WHERE table_name = 'USUARIOS' AND constraint_type = 'P';
EXIT;
SQL
)
if echo "$PK_EXISTS" | grep -qi "usuarios_pk"; then
    echo -e "   ${GREEN}‚úì Primary key usuarios_pk encontrada${NC}"
else
    echo -e "   ${YELLOW}‚ö† Primary key n√£o encontrada${NC}"
fi

# 3.5. Testar inser√ß√£o de dados (opcional)
echo "   3.5. Testando inser√ß√£o de dados..."
INSERT_TEST=$(docker compose exec -T oracle19c sqlplus -s laraveldb/"${LARAVEL_PWD}"@localhost:1521/ORCLPDB1 <<'SQL' 2>&1
SET PAGESIZE 0 FEEDBACK OFF VERIFY OFF HEADING OFF ECHO OFF
WHENEVER SQLERROR EXIT SQL.SQLCODE
INSERT INTO usuarios (nome) VALUES ('Teste');
COMMIT;
SELECT COUNT(*) FROM usuarios WHERE nome = 'Teste';
DELETE FROM usuarios WHERE nome = 'Teste';
COMMIT;
EXIT;
SQL
)
if echo "$INSERT_TEST" | grep -q "1"; then
    echo -e "   ${GREEN}‚úì Inser√ß√£o e exclus√£o de dados funcionando${NC}"
else
    echo -e "   ${YELLOW}‚ö† Teste de inser√ß√£o falhou ou tabela vazia${NC}"
fi

echo ""
echo -e "${GREEN}=========================================="
echo "‚úì Valida√ß√£o completa - Usu√°rio laraveldb pronto!"
echo "==========================================${NC}"
echo ""
echo "üìä Informa√ß√µes de acesso:"
echo "   Usu√°rio: laraveldb"
echo "   Senha: Oracle123Secure"
echo "   Service: ORCLPDB1"
echo "   Host: localhost"
echo "   Port: 1521"
echo ""
echo "üìù Exemplo de conex√£o JDBC:"
echo "   jdbc:oracle:thin:@localhost:1521/ORCLPDB1"
echo ""
echo "üìù Exemplo de conex√£o SQL*Plus:"
echo "   docker compose exec oracle19c sqlplus laraveldb/Oracle123Secure@localhost:1521/ORCLPDB1"
echo ""
echo "üìù Para validar novamente:"
echo "   ./validate-oracle.sh"
echo ""

